import{l as $,b as r,d as u,t as x,aF as Le,k as M,a as C,o as De,bO as v,bC as Be,e as n,u as Ee,w,F as h,Z as Ke,f as o,g,i as S,m as X,bw as ne,bz as Ue,X as re,n as qe,bP as b,aE as Y,O as ze}from"./vue.m-BoM48gZa.js";import{A as Re}from"./AuthenticatedLayout-Di-2FOMO.js";import{_ as p}from"./InputError-siFCQWKO.js";import{_ as B}from"./TextInput-lN6ApOBV.js";import{_ as y}from"./InputLabel-fjeUReQI.js";import{L as ie}from"./LoadingModal-BiCFBVY5.js";import{g as Fe,s as Pe,a as Ge}from"./Ajax-ltBwR52q.js";import{_ as Oe}from"./FooterButtons-DwrU-TYt.js";import{_ as je}from"./CancelButton-CYN4UORr.js";import{_ as Xe}from"./SearchableSelect-c4Tn9ZOx.js";import{I as Ye}from"./InputDescription-CYIYYTfy.js";import{_ as Ze}from"./SubButton-BQXSgC_f.js";import{R as He}from"./ResponsiveTable-D6b5B55q.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./BaseButton-CVzmqfRt.js";const Je=(f,_="1.12.1")=>new Sketchfab(_,f),ue={__name:"NumberFormatLabel",props:{value:{required:!0},size:{type:String,default:"md"}},setup(f){const _=f,T=$(()=>{const A={sm:"bg-gray-200 text-black rounded px-1.5 text-sm",md:"bg-gray-200 text-black rounded px-1.5 text-base",lg:"bg-gray-200 text-black rounded px-1.5 text-lg"};return A[_.size]||A.md});return(A,E)=>f.value>0?(r(),u("span",{key:0,class:Le(T.value)},x(new Intl.NumberFormat().format(f.value)),3)):M("",!0)}},Qe=o("h2",{class:"font-semibold text-indigo-50 leading-tight"},"商品追加・編集（360°VR）",-1),We={class:"sm:py-6"},et={class:"max-w-7xl mx-auto sm:px-6 lg:px-8"},tt={class:"bg-white overflow-hidden shadow-sm"},st={class:"container mx-auto p-5 sm:p-10 text-gray-900"},ot={class:"grid grid-cols-1 md:grid-cols-2 gap-10"},at={class:"sm:mb-5"},lt={class:"mb-5"},nt={class:"mb-5"},rt={class:"mb-4"},it={class:"flex"},ut={class:"md:flex mb-5 md:mb-0"},ct={class:"flex-grow"},dt={class:"mb-5"},mt={class:"text-sm"},pt={class:"mb-1.5"},_t={class:"flex items-center"},vt=["value"],ft=["textContent"],gt={class:"mb-10"},ht={class:"text-sm"},bt={class:"mb-1.5"},yt={class:"flex items-center"},xt=["value"],kt=["textContent"],Ct=["textContent"],wt={class:"mb-6"},Mt={class:"my-5"},Nt=o("iframe",{src:"",id:"sketchfab-iframe",allow:"autoplay; fullscreen; xr-spatial-tracking","xr-spatial-tracking":"","execution-while-out-of-viewport":"","execution-while-not-rendered":"","web-share":"",allowfullscreen:"",mozallowfullscreen:"true",webkitallowfullscreen:"true"},null,-1),Vt=[Nt],St={class:"mb-5"},$t={key:0},It={id:"table",class:"w-full"},Tt=o("thead",{class:"text-xs bg-indigo-600"},[o("tr",null,[o("th",{class:"p-2 border border-gray-300 text-left text-indigo-50 font-bold text-nowrap text-xs"},"名前"),o("th",{class:"p-2 border border-gray-300 text-left text-indigo-50 font-bold text-xs"},"構成パーツ設定")])],-1),At={class:"relative border border-gray-300 p-3 align-top text-nowrap w-1/4"},Lt={class:"flex"},Dt={class:"text-base pt-1"},Bt={class:"text-xs pl-0.5 text-gray-500"},Et={class:"border border-gray-300 text-xs align-top p-3 pb-6 w-full"},Kt={class:"flex p-2"},Ut={class:"relative"},qt=["value","onInput"],zt=o("div",{class:"pt-3 text-xs"}," 円 ",-1),Rt={class:"flex flex-wrap px-6 pt-3 pb-1"},Ft={class:"flex items-center"},Pt=["checked","onChange"],Gt=["textContent"],Ot={key:0,class:"text-sm px-4 pt-4"},jt={class:"bg-indigo-600 text-indigo-50 px-3 pt-1.5 pb-2 text-xs rounded-t font-bold"},Xt={class:"mt-0 border-gray-300 border-b border-r border-l shadow-md"},Yt={class:"bg-gray-100 border-b border-indigo-200"},Zt={class:"flex px-2 pt-1.5 pb-2.5"},Ht={class:"relative"},Jt=["value","onInput"],Qt=o("div",{class:"pt-3 text-xs"}," 円 ",-1),Wt={class:"pt-4 pb-5 px-4 bg-white"},es={class:"flex flex-wrap pl-1"},ts={class:"flex items-center"},ss=["checked","onChange"],os={class:"pb-5 px-4 bg-white"},as={class:"flex flex-wrap pl-1"},ls={class:"flex items-center"},ns=["checked","onChange"],rs={key:0},is=o("td",{class:"border border-gray-300 pl-3 pr-6 py-2 align-top text-nowrap",colspan:"2"},[o("div",{class:"text-sm text-yellow-700"}," パーツが見つかりません。 ")],-1),us=[is],cs={key:1,class:"text-sm text-yellow-700"},ds=o("br",null,null,-1),ms={key:0,class:"mb-1 inline-flex relative mx-3 my-1"},ps={key:0,class:"absolute right-2 top-1"},$s={__name:"Input",props:{product:{type:Object,default(){return{}}},shops:{type:Array,required:!0},productCategories:{type:Array,required:!0},materials:{type:Array,required:!0},componentGroups:{type:Array,required:!0},materialCombinationTypes:{type:Array,required:!0},allComponentGroupTypeKeys:{type:Object,required:!0}},setup(f){const _=f,T=C(!1),A=$(()=>Number(_.product.id)===0),E=$(()=>Number(_.product.id)>0);De(()=>{if(we(),E.value===!0){const s=_.product;i.value.product={category_id:s.category_id||"",name:s.name||"",product_code:s.product_code||"",shop_id:s.shop_id||"",sort_number:s.sort_number>=0?s.sort_number:"",sketchfab_model_key:s.sketchfab_model_key||"",material_combination_type:s.material_combination_type||""},i.value.components=s.components.map(l=>({key:l.key,groupKey:l.group_key,name:l.name,is_active:l.is_active,materials:l.materials}));const e=s.components.map(l=>l.key),t=_.componentGroups.filter(l=>e.includes(l.value));W(t)}});const Z={product:{category_id:"",name:"",product_code:"",shop_id:"",sort_number:"",sketchfab_model_key:"",material_combination_type:""},components:[]},i=C(v.cloneDeep(Z)),d=C({}),I=C(!1);let H=[];const ce=()=>{i.value=v.cloneDeep(Z),d.value={},U.value=!1},J=()=>{i.value.components.length>0&&(H=v.cloneDeep(i.value.components))},de=()=>{J(),U.value=!1},me=()=>{b.input("URLを入力してください。","SketchfabのURL").then(t=>{if(t.isConfirmed){const l=route("admin.product.extract_unique_id"),a={url:t.value};axios.post(l,a).then(m=>{i.value.product.sketchfab_model_key=m.data.unique_id,Y(()=>{oe()})}).catch(()=>{b.error("ユニークIDの取得に失敗しました。")})}})},pe=()=>{b.confirm("normal").then(s=>{if(s.isConfirmed){T.value=!0;const e=i.value;let t={_method:"POST",product:e.product,components:e.components.map(a=>({key:a.key,is_active:a.is_active,materials:a.materials.map(m=>({material_id:m.material_id,is_active:m.is_active,amount:m.amount,colors:m.colors.map(c=>({material_color_id:c.material_color_id,is_active:c.is_active})),normal_maps:m.normal_maps.map(c=>({material_normal_map_id:c.material_normal_map_id,is_active:c.is_active}))}))}))},l="";E.value===!0?(l=route("admin.product.update",_.product.id),t._method="PUT"):l=route("admin.product.store"),axios.post(l,t).then(a=>{a.data.result===!0?(A.value===!0&&ce(),d.value={},b.success()):b.error()}).catch(a=>{N.value="",d.value=Fe(a),b.error(),Y(()=>{Pe()})}).finally(()=>T.value=!1)}})},Q=C(),W=s=>{let e=[];s.forEach(t=>{const l=t.value;if(L==="keep_data"){const a=H.find(m=>m.key===l);a&&e.push(a)}else{const a=t.label,m=t.group_key,c=_e(l);let q=[];_.materials.forEach((D,Ie)=>{if(Ie>0&&m==="logo")return;const z=L!=="none"?null:k(c,D),Te=D.colors.map(V=>{const j=P(z,V);return{material_color_id:V.id,name:V.name,is_active:v.get(j,"is_active",!1)}}),Ae=D.normal_maps.map(V=>{const j=G(z,V);return{material_normal_map_id:V.id,name:V.name,is_active:v.get(j,"is_active",!1)}});q.push({material_id:D.id,name:D.name,is_active:v.get(z,"is_active",!1),amount:v.get(z,"amount",""),colors:Te,normal_maps:Ae})}),e.push({key:l,name:a,group_key:m,is_active:v.get(c,"is_active",!0),materials:q})}}),i.value.components=e,L="none"},_e=s=>i.value.components.find(e=>e.key===s),ve=()=>{N.value="",Q.value.focus()},R=$(()=>i.value.components),F=$(()=>R.value.filter(s=>{const e=N.value.toLowerCase(),t=s.name,l=s.key.toLowerCase();return t.includes(e)||l.includes(e)})),ee=$(()=>R.value.length>0),k=(s,e=null)=>!s||!e?null:s.groupKey==="logo"?s.materials[0]:s&&s.materials?s.materials.find(t=>Number(t.material_id)===Number(e.id)):null,fe=s=>s.some(e=>e.is_active),te=(s,e)=>{const t=k(s,e);return v.get(t,"is_active",!1)},ge=(s,e)=>{let t=k(s,e);t.is_active=!t.is_active},se=(s,e)=>{const t=k(s,e);return v.get(t,"amount","")},he=(s,e,t)=>{const l=k(e,t);l.amount=Number(s.target.value)},be=(s,e)=>{e.materials[0].amount=Number(s.target.value)},P=(s,e)=>s&&s.colors?s.colors.find(t=>Number(t.material_color_id)===Number(e.id)):null,ye=(s,e,t)=>{const l=k(s,e),a=P(l,t);return v.get(a,"is_active",!1)},xe=(s,e,t)=>{const l=k(s,e),a=P(l,t);a.is_active=!a.is_active},G=(s,e)=>s&&s.normal_maps?s.normal_maps.find(t=>Number(t.material_normal_map_id)===Number(e.id)):null,ke=(s,e,t)=>{const l=k(s,e),a=G(l,t);return v.get(a,"is_active",!1)},Ce=(s,e,t)=>{const l=k(s,e);l.normal_maps.forEach(a=>{a.is_active=!1}),Y(()=>{const a=G(l,t);a.is_active=!0})};let O=null,L="none";const K=C(!1),U=C(!1),we=()=>{const s=document.getElementById("sketchfab-iframe");O=Je(s)},Me=s=>{O&&(K.value=!0,O.init(s,{success(e){Ne(e)},error(){b.error("データ取得できませんでした。Sketchfab IDを確認してください。"),K.value=!1}}))},Ne=s=>{s.start(),s.addEventListener("viewerready",()=>{s.getMaterialList((e,t)=>{if(!e){const l=Ve(t);W(l),U.value=!0,K.value=!1}})})},oe=()=>{J();const s=i.value.product.sketchfab_model_key;if(!s){b.error("Sketchfab ユニークIDを入力してください。");return}b.fire({title:"確認",text:"現在の「構成パーツ設定」はどうしますか？",showDenyButton:!0,showCancelButton:!0,denyButtonText:"破棄する",confirmButtonText:"保持したままにする",cancelButtonText:"閉じる",reverseButtons:!0}).then(e=>{(e.isDenied||e.isConfirmed)&&(e.isDenied?L="clear_data":e.isConfirmed&&(L="keep_data"),Me(s))})},N=C(""),ae=C(!1),Ve=s=>{let e=[];return _.componentGroups.forEach(t=>{const l=t.value;for(const a in s)s[a].name.includes(l)&&e.push(t)}),v.uniq(e)};Be(()=>N.value,s=>{s&&(ae.value=!1,setTimeout(()=>{if(ae.value===!1){const e=document.querySelector("#table");Ge(e)}},1e3))});const Se=$(()=>E.value===!0),le=()=>{b.confirm("cancel","もし入力した内容がある場合、破棄されます。<br>よろしいですか？").then(s=>{s.isConfirmed&&ze.visit(route("admin.product.index"))})},$e=()=>{window.open(_.product.detail_url,"_blank")};return(s,e)=>(r(),u(h,null,[n(Ee(Ke),{title:"商品追加・編集（360°VR）"}),n(Re,null,{header:w(()=>[Qe]),default:w(()=>[o("div",We,[o("div",et,[o("div",tt,[o("div",st,[o("div",ot,[o("div",null,[o("div",at,[n(y,{value:"商品名"}),n(B,{type:"text",class:"mt-1 block w-full",modelValue:i.value.product.name,"onUpdate:modelValue":e[0]||(e[0]=t=>i.value.product.name=t),autocomplete:"name"},null,8,["modelValue"]),n(p,{message:d.value["product.name"]},null,8,["message"])]),o("div",lt,[n(y,{value:"商品コード","sub-title":"（重複しない文字列）"}),n(B,{type:"text",class:"mt-1 block w-full",modelValue:i.value.product.product_code,"onUpdate:modelValue":e[1]||(e[1]=t=>i.value.product.product_code=t),autocomplete:"product_code"},null,8,["modelValue"]),n(p,{message:d.value["product.product_code"]},null,8,["message"])]),o("div",nt,[n(y,{value:"販売店舗"}),n(Xe,{items:_.shops,modelValue:i.value.product.shop_id,"onUpdate:modelValue":e[2]||(e[2]=t=>i.value.product.shop_id=t)},null,8,["items","modelValue"]),n(p,{message:d.value["product.shop_id"]},null,8,["message"])]),o("div",rt,[n(y,{value:"並び順"}),n(B,{type:"text",class:"mt-1 block",modelValue:i.value.product.sort_number,"onUpdate:modelValue":e[3]||(e[3]=t=>i.value.product.sort_number=t),autocomplete:"product_code"},null,8,["modelValue"]),n(Ye,null,{default:w(()=>[g(" 店舗内での表示順。数字が大きいほど上に表示されます。 ")]),_:1}),n(p,{message:d.value["product.sort_number"]},null,8,["message"])]),o("div",it,[o("div",null,[n(y,{value:"Sketchfab ID"})]),o("div",{class:"flex-grow text-xs pt-1"},[g(" （"),o("a",{href:"#",class:"text-indigo-800 hover:underline text-xs",onClick:me},"URLから取得"),g("） ")])]),o("div",ut,[o("div",null,[n(B,{type:"text",class:"mt-0 mr-1 w-72",modelValue:i.value.product.sketchfab_model_key,"onUpdate:modelValue":e[4]||(e[4]=t=>i.value.product.sketchfab_model_key=t),onInput:de},null,8,["modelValue"]),n(p,{message:d.value["product.sketchfab_model_key"]},null,8,["message"])]),o("div",ct,[n(je,{size:"sm",class:"mt-0.5 ml-0.5",onClick:oe},{default:w(()=>[g("モデル取得")]),_:1})])])]),o("div",null,[o("div",dt,[n(y,{value:"カテゴリ"}),o("div",mt,[(r(!0),u(h,null,S(f.productCategories,t=>(r(),u("div",pt,[o("label",_t,[X(o("input",{type:"radio","onUpdate:modelValue":e[5]||(e[5]=l=>i.value.product.category_id=l),value:t.id},null,8,vt),[[ne,i.value.product.category_id]]),o("span",{class:"ml-2",textContent:x(t.name)},null,8,ft)])]))),256))]),n(p,{message:d.value["product.category_id"]},null,8,["message"])]),o("div",gt,[n(y,{value:"素材組み合わせ"}),o("div",ht,[(r(!0),u(h,null,S(f.materialCombinationTypes,t=>(r(),u("div",bt,[o("label",yt,[X(o("input",{type:"radio","onUpdate:modelValue":e[6]||(e[6]=l=>i.value.product.material_combination_type=l),value:t.value},null,8,xt),[[ne,i.value.product.material_combination_type]]),o("span",{class:"ml-2",textContent:x(t.label)},null,8,kt),g("："),o("small",{class:"ml-2",textContent:x(t.description)},null,8,Ct)])]))),256))]),n(p,{message:d.value["product.material_combination_type"]},null,8,["message"])])])]),o("div",wt,[X(o("div",Mt,Vt,512),[[Ue,U.value]])]),o("div",null,[n(y,{value:"構成パーツ","sub-title":`（${F.value.length}/${R.value.length}件表示）`},null,8,["sub-title"])]),o("div",St,[n(p,{message:d.value.keys},null,8,["message"]),ee.value?(r(),u("div",$t,[n(He,{class:"mb-4"},{default:w(()=>[o("table",It,[Tt,o("tbody",null,[(r(!0),u(h,null,S(F.value,(t,l)=>(r(),u("tr",{key:t.key},[o("td",At,[o("label",Lt,[o("div",Dt,[o("div",null,x(t.name),1),o("div",Bt,x(t.key),1)])]),n(p,{message:d.value[`components.${l}.is_active`]},null,8,["message"])]),o("td",Et,[t.group_key==="logo"?(r(),u(h,{key:0},[o("div",Kt,[o("div",Ut,[I.value?(r(),re(ue,{key:0,class:"absolute",size:"sm",style:{top:"9px",right:"9px"},value:t.materials[0].amount},null,8,["value"])):M("",!0),o("input",{type:"number",class:"mt-1 mr-1 block w-42 border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 text-sm p-1",value:t.materials[0].amount,min:"0",onInput:a=>be(a,t),onFocus:e[7]||(e[7]=a=>I.value=!0),onBlur:e[8]||(e[8]=a=>I.value=!1)},null,40,qt)]),zt]),n(p,{message:d.value[`components.${l}`]},null,8,["message"]),n(p,{message:d.value[`components.${l}.materials.0`]},null,8,["message"])],64)):(r(),u(h,{key:1},[o("div",Rt,[(r(!0),u(h,null,S(f.materials,a=>(r(),u("div",{class:"w-1/4 my-1",key:a.material_id},[o("label",Ft,[o("input",{type:"checkbox",checked:te(t,a),onChange:m=>ge(t,a)},null,40,Pt),o("span",{class:"ml-1 font-bold",textContent:x(a.name)},null,8,Gt)])]))),128)),n(p,{class:"w-full",message:d.value[`components.${l}`]},null,8,["message"])]),fe(t.materials)?(r(!0),u(h,{key:0},S(f.materials,(a,m)=>(r(),u("div",{key:a.id},[te(t,a)?(r(),u("div",Ot,[o("div",jt,x(a.name),1),o("div",Xt,[o("div",Yt,[o("div",Zt,[o("div",Ht,[I.value?(r(),re(ue,{key:0,class:"absolute",size:"sm",style:{top:"9px",right:"9px"},value:se(t,a)},null,8,["value"])):M("",!0),o("input",{type:"number",class:"mt-1 mr-1 block w-42 border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 text-sm p-1",value:se(t,a),min:"0",onInput:c=>he(c,t,a),onFocus:e[9]||(e[9]=c=>I.value=!0),onBlur:e[10]||(e[10]=c=>I.value=!1)},null,40,Jt)]),Qt]),n(p,{message:d.value[`components.${l}.materials.${m}`]},null,8,["message"])]),o("div",Wt,[n(y,{value:"カラー",class:"ml-1 text-xs"}),o("div",es,[(r(!0),u(h,null,S(a.colors,c=>(r(),u("div",{class:"w-1/4",key:c.id},[o("label",ts,[o("input",{type:"checkbox",class:"mr-1",checked:ye(t,a,c),onChange:q=>xe(t,a,c)},null,40,ss),g(" "+x(c.name),1)])]))),128))]),n(p,{message:d.value[`components.${l}.materials.${m}.colors`]},null,8,["message"])]),o("div",os,[n(y,{value:"ノーマルマップ",class:"ml-1 text-xs"}),o("div",as,[(r(!0),u(h,null,S(a.normal_maps,c=>(r(),u("div",{class:"w-1/3",key:c.id},[o("label",ls,[o("input",{type:"checkbox",class:"mr-1",checked:ke(t,a,c),onChange:q=>Ce(t,a,c)},null,40,ns),g(" "+x(c.name),1)])]))),128))]),n(p,{message:d.value[`components.${l}.materials.${m}.normal_maps`]},null,8,["message"])])])])):M("",!0)]))),128)):M("",!0)],64))])]))),128)),F.value.length===0?(r(),u("tr",rs,us)):M("",!0)])])]),_:1})])):(r(),u("div",cs,[g(" パーツがありません。"),ds,g(" モデルデータを取得してください。 ")]))]),n(p,{message:d.value.components},null,8,["message"])])])])]),n(Oe,{"show-confirm":Se.value,onYesClick:pe,onNoClick:le,onConfirmClick:$e},{left:w(()=>[n(Ze,{size:"md",href:s.route("admin.product.input"),onClick:le},{default:w(()=>[g("新規追加")]),_:1},8,["href"]),ee.value?(r(),u("div",ms,[n(B,{ref_key:"componentSearchInput",ref:Q,type:"text",class:"mt-1 block w-52 mb-1",placeholder:"構成パーツ・絞り込み",modelValue:N.value,"onUpdate:modelValue":e[11]||(e[11]=t=>N.value=t)},null,8,["modelValue"]),N.value?(r(),u("div",ps,[o("a",{href:"#",class:"text-gray-500 text-2xl",onClick:qe(ve,["prevent"])},"×")])):M("",!0)])):M("",!0)]),_:1},8,["show-confirm"]),n(ie,{show:T.value},null,8,["show"]),n(ie,{show:K.value},{default:w(()=>[g("読み込み中...")]),_:1},8,["show"])]),_:1})],64))}};export{$s as default};
